# Spring 동시성 제어 심화 (Concurrency Control)

실무에서 가장 까다로운 문제 중 하나인 **동시성 이슈(Race Condition)**를 해결하기 위한 다양한 락(Lock) 전략과 데드락(Deadlock)에 대해 학습합니다.

## 1. 동시성 이슈란?
여러 스레드(또는 트랜잭션)가 동시에 하나의 자원(예: 재고)에 접근하여 수정할 때, 데이터의 정합성이 깨지는 현상입니다.
*   예: 재고가 100개일 때, 두 명이 동시에 1개씩 주문했는데 재고가 99개가 되는 현상 (정상이라면 98개여야 함).

## 2. 해결 전략 (Lock Strategies)

### A. 비관적 락 (Pessimistic Lock)
*   **개념**: "충돌이 무조건 발생할 것이다"라고 가정하고, 데이터를 읽을 때부터 DB 락을 걸어버립니다.
*   **구현**: JPA의 `@Lock(LockModeType.PESSIMISTIC_WRITE)` -> SQL `SELECT ... FOR UPDATE`
*   **장점**: 데이터 정합성이 확실하게 보장됩니다.
*   **단점**: 락을 잡고 있는 동안 다른 요청들은 대기해야 하므로 **성능 저하**가 발생할 수 있습니다. 데드락 위험이 있습니다.

### B. 낙관적 락 (Optimistic Lock)
*   **개념**: "충돌이 거의 없을 것이다"라고 가정하고, 실제 락을 걸지 않습니다. 대신 **버전(Version)** 정보를 이용하여 충돌을 감지합니다.
*   **구현**: Entity에 `@Version` 필드 추가.
*   **동작**:
    1.  데이터 읽기 (version: 1)
    2.  수정 시도 (update ... set version = 2 where id = ? and version = 1)
    3.  만약 그 사이 누군가 수정해서 version이 2가 되었다면, `Row count`가 0이 되어 예외 발생.
*   **장점**: DB 락을 걸지 않아 성능이 좋습니다.
*   **단점**: 충돌 발생 시 **재시도(Retry) 로직**을 개발자가 직접 구현해야 합니다.

### C. 분산 락 (Distributed Lock with Redis)
*   **개념**: 여러 서버(Scale-out 환경)에서 공통된 자원에 접근할 때 사용하는 락입니다. DB 부하를 줄이기 위해 Redis 같은 별도 저장소를 이용합니다.
*   **구현**: **Redisson** 라이브러리 사용.
*   **특징**:
    *   **Pub/Sub 방식**: 락이 해제되면 대기 중인 스레드에게 알림을 줍니다. (스핀 락 방식보다 Redis 부하 적음)
    *   **Lease Time**: 락을 획득하고 일정 시간이 지나면 자동으로 해제되어, 서버가 죽어도 락이 영원히 남는 것을 방지합니다.

## 3. 교착 상태 (Deadlock) & 라이브락 (Livelock)

### 데드락 (Deadlock)
*   **정의**: 두 개 이상의 프로세스가 서로 상대방이 가진 자원을 기다리며 무한 대기 상태에 빠지는 것.
*   **조건**: 상호 배제, 점유 대기, 비선점, 순환 대기.
*   **해결**: 자원 접근 순서를 통일하거나, 타임아웃을 설정합니다.

### 라이브락 (Livelock)
*   **정의**: 프로세스들이 서로 양보(락 해제)만 반복하다가 아무런 작업도 진행하지 못하는 상태.
*   **비유**: 좁은 길에서 두 사람이 마주쳤을 때, 서로 비켜주려고 왼쪽/오른쪽으로 동시에 움직이다가 계속 제자리에 있는 상황.
*   **해결**: 재시도 시 랜덤한 대기 시간(Jitter)을 부여합니다.

## 4. 실행 및 테스트 방법

### 사전 준비
*   **Redis 실행**: 로컬 환경에 Redis가 실행 중이어야 합니다. (기본 포트 6379)
    *   Docker 사용 시: `docker run -d -p 6379:6379 redis`

### API 테스트
1.  **재고 생성**
    *   `POST /stocks?productId=1&quantity=100`
    *   응답: 생성된 Stock ID (예: 1)

2.  **비관적 락 테스트**
    *   `POST /stocks/1/decrease/pessimistic?quantity=1`
    *   JMeter 등으로 동시에 여러 요청을 보내도 재고가 정확히 감소하는지 확인.

3.  **낙관적 락 테스트**
    *   `POST /stocks/1/decrease/optimistic?quantity=1`
    *   충돌 발생 시 재시도 로직이 동작하여 결국 성공하는지 확인.

4.  **분산 락 테스트**
    *   `POST /stocks/1/decrease/redisson?quantity=1`
    *   Redis를 통해 락이 제어되는지 확인.

5.  **데드락 유발**
    *   `GET /deadlock`
    *   콘솔 로그를 확인하여 두 스레드가 서로를 기다리며 멈춰있는지 확인.
